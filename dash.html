<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="UTF-8">

<!-- <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css"> -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.8.1/css/lightbox.min.css">

</head>
<body>

<div id="map-canvas" style="width: 750px; height: 400px"></div>

<div style="width: 750px; height: 40px;">
  <form id="filters">
    <div style="position: relative; float: left; padding: 5px;">
      <input name="min" type="text" id="start-date" value="1970-01-01T00:00:00-07:00" placeholder="Start" style="width: 160px;" />
    </div>
    <div style="position: relative; float: left; padding: 5px;">
      <input name="max" type="text" id="end-date" value="2020-12-31T23:59:59-07:00" placeholder="End" style="width: 160px;">
    </div>
    <div style="position: relative; float: left; padding: 5px;">
      <select name="tr" id="trigger">
        <option value="">All</option>
        <option value="motion">Motion</option>
        <option value="user">User</option>
      </select>
    </div>
    <div style="position: relative; float: left; padding: 5px;">
      <select name="id" id="botId">
        <option value="">All</option>
        <option value="markbot1">markbot1</option>
        <option value="markbot2">markbot2</option>
      </select>
    </div>
    <div style="position: relative; float: left; padding: 5px;">
      <select name="length" id="length">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="40" selected="true">40</option>
        <option value="80">80</option>
        <option value="320">320</option>
      </select>
    </div>
  </form>
</div>

<table id="summary">
</table>

<div id="result" style="width: 750px;"></div>

<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
<script src="//maps.googleapis.com/maps/api/js?AIzaSyDUsZCP04vN4oxSQBcHmz1YGbTq8RTMEvw"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.8.1/js/lightbox.min.js"></script>

<script src="config.js"></script>
<script src="Bot.js"></script>
<script src="Photo.js"></script>

<script>

$(document).ready(function () {

  var min = '',
      max = '',
      botsToColors = {},
      userCoords = {};

  function getPhotos() {
    // TODO make this configurable
    var str = $('form').serialize();
    photos = [];
    bots = {};
    $.ajax('http://'+config.dashboard.host+':'+config.dashboard.port+'/api/data?' + str)
      .done(function(data) {
        if ( console && console.log ) {
          console.log( data );
        }
        $('#result').html('');
        data.forEach(function(res) {
          var p = new APP.Photo(res);
          // if bot ID not recognized, create a new one in bots obj
          var botId = p.getBotId();
          if (!bots[botId]) {
            var b = new APP.Bot(res);
            b.addPhoto(p);
            bots[botId] = b;
          }
          // else add photo to existing bot obj
          else {
            bots[botId].addPhoto(p);
          }
          p.setBot(bots[botId]);
          photos.push(p);
          console.log("URI: " + p.getUri());
          // TODO make this configurable
          var img = '<a href="http://'+config.dashboard.host+':'+config.dashboard.port+'/api/photo?uri=' +
                    p.getUri() + '" data-lightbox="markbot" data-title="' + p.getLastMod() + '">';
          img += '<img src="http://'+config.dashboard.host+':'+config.dashboard.port+'/api/photo?uri=' +
                    p.getUri() + '" id="'+p.getUri()+'" style="width: 150px" />';
          img += '</a>';
          $('#result').append(img);
        });

        // if (photos.length > 0) {
        //   $('#start-date').val(photos[photos.length - 1].properties['$ml.prop']['last-modified']);
        //   $('#end-date').val(photos[0].properties['$ml.prop']['last-modified']);
        // }

        // Set up table
        for (var prop in bots) {
          $('#summary').html('<tr><td>Bot</td><td>Lat</td><td>Lon</td><td>Actions</td></tr>');
          b = bots[prop];
          var coords = b.getCoords();
          var row = '<tr><td>'+b.getId()+'</td><td>'+coords.lat+'</td><td>'+coords.lon+'</td><td><input type="button" name="'+b.getId()+'" value="capture" /></td></tr>';
          $('#summary').append(row);
        }

        setUpMap(bots, photos);
      }
    );
  }
  var options = {
        center: {},
        scrollwheel: false,
        zoom: 18
  };

  function setUpMap(bots, photos) {
    // Get user GPS coords
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          // Store coords for possible future use
          userCoords.lat = position.coords.latitude;
          userCoords.lon = position.coords.longitude;
      });
    } else {
        console.log("Geolocation is not supported by this browser.");
    }
    firstCoords = photos[0].getCoords();
    options.center.lat = firstCoords.lat;
    options.center.lng = firstCoords.lon;
    var map = new google.maps.Map(document.getElementById('map-canvas'), options);

    coordsForLine = [];
    photos.forEach(function(photo) {
      var coords = photo.getCoords();
      if (coords.lat && coords.lon) {
        var marker = new google.maps.Marker({
          map: map,
          position: {
            lat: coords.lat,
            lng: coords.lon
          },
          title: photo.getUri(),
          icon: 'images/'+photo.getBotId()+'.png'
        });
        coordsForLine.push({lat: coords.lat, lng: coords.lon});
        // Open lightbox image on marker click
        google.maps.event.addListener(marker, 'click', function() {
          actuateLink(document.getElementById(photo.getUri()));
        });
      }
    });

    var photoPath = new google.maps.Polyline({
      path: coordsForLine,
      geodesic: true,
      strokeColor: '#FF0000',
      strokeOpacity: 1.0,
      strokeWeight: 2
    });

    photoPath.setMap(map);
  }

  // Set up filters
  //$( "#start-date" ).datepicker({"setDate": "10/12/2012"});
  //$( "#end-date" ).datepicker({"setDate": "4/12/2014"});

  $( "input[type='text']" ).on( "focusout", getPhotos );
  $( "select" ).on( "change", getPhotos );
  getPhotos();

  // http://blog.stchur.com/2010/01/15/programmatically-clicking-a-link-in-javascript/
  // To activat lightbox link on marker click. Not sure if all browsers support this.
  function actuateLink(link) {
     var allowDefaultAction = true;
     if (link.click) {
        link.click();
        return;
     }
     else if (document.createEvent) {
        var e = document.createEvent('MouseEvents');
        e.initEvent(
           'click'     // event type
           ,true      // can bubble?
           ,true      // cancelable?
        );
        allowDefaultAction = link.dispatchEvent(e);
     }

     if (allowDefaultAction) {
        var f = document.createElement('form');
        f.action = link.href;
        document.body.appendChild(f);
        f.submit();
     }
  }

});

</script>

</body>
</html>
